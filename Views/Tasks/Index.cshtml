@model TaskManager.Web.Models.TaskViewModel

@{
    ViewData["Title"] = "Tasks";
    ViewData["Heading"] = "Tasks";
}

@section HeaderScripts {


    <style>
        th.progressCls {
            width: 10px !important;
        }

        /*tr.selected
        {background-color:#dee2e6 !important}*/

        table.dataTable tbody td.select-checkbox, table.dataTable tbody th.select-checkbox {
          width: 2px !important;
          /*height: 10px !important;*/
          margin: 0px;
          /*margin-top:10px !important;*/
          margin-left: -20px;
          -webkit-appearance: none;
          -moz-appearance: none;
          -o-appearance: none;
          appearance: none;
          box-shadow: none;
          font-size: 0.6em;
          line-height: 6em;
          /*text-align: left;
          line-height: 1.9em;*/
        }

         td.select-checkbox:before {
              margin-top: 10px !important;            
        }

        .select2-results__option[aria-selected=true] {
            display: none;
        }

        #tasksTable th {
          background-color: #343a40;
          color: white;
        }

        table.dataTable tbody tr.selected {
            color: white;
            background-color: #7d91b0;
        }

    </style>

}

<div class="container-fluid">

    <div class="row">
        <div class="col-12">
            <!-- Default box -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Summary</h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-tool" data-card-widget="collapse" title="Collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row" id="summaryRow">
                        <div class="col-6 col-md-3 text-center">
                            <input id="totalTasksId" type="text" class="knob" value="30" data-width="120" data-height="120"
                                   data-fgColor="#3c8dbc">
                            <div class="knob-label">Total</div>
                        </div>
                        <div class="col-6 col-md-3 text-center">
                            <input id="pendingTasksId" type="text" class="knob" value="30" data-width="120" data-height="120"
                                   data-fgColor="#3c8dbc">

                            <div class="knob-label">Pending</div>
                        </div>
                        <div class="col-6 col-md-3 text-center">
                            <input id="completedTasksId" type="text" class="knob" value="30" data-width="120" data-height="120"
                                   data-fgColor="#3c8dbc">
                            <div class="knob-label">Completed</div>
                        </div>
                        <div class="col-6 col-md-3 text-center">
                            <input id="onHoldTaskId" type="text" class="knob" value="30" data-width="120" data-height="120"
                                   data-fgColor="#3c8dbc">
                            <div class="knob-label">On Hold</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.card -->
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <!-- Default box -->
            <div class="card collapsed-card">
                <div class="card-header">
                    <i class="fa fa-filter" style="float:left" aria-hidden="true"></i>
                    <h3 class="card-title">Filters</h3>
                    <div class="card-tools">
                        <button id="filterCollapseBtnId" type="button" class="btn btn-tool" aria-expanded="false" data-card-widget="collapse" title="Collapse">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row" style="height:40px;">
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>Task Name</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <input id="taskNameId" type="text" class="form-control">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <button id="clearTaskNameId" class="btn btn-default"><i class="fa fa-close"></i>Clear</button>
                            </div>
                        </div>
                    </div>
                    <div class="row" style="height:40px;">
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>Status</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <select id="statusSelectValuesId" class="select2" multiple="multiple" data-placeholder="Select status" style="width: 100%;">
                                    <option>Not Started</option>
                                    <option>In Progress</option>
                                    <option>On Hold</option>
                                    <option>Cancelled</option>
                                    <option>Completed</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4" style="text-align:left">
                            <div class="form-group">
                                <button id="clearStatusId" class="btn btn-default"><i class="fa fa-close"></i>Clear</button>
                                <button id="defaultStatusId" class="btn btn-default"><i class="far fa-circle"></i>Default</button>

                            </div>
                        </div>
                    </div>

                    <div class="row" style="height:40px;">
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>Assigned To</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <select id="assignSelectValuesId" class="select2" multiple="multiple" data-placeholder="Select assigned to" style="width: 100%;">
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <button id="clearAssignId" class="btn btn-default"><i class="fa fa-close"></i>Clear</button>
                                <button id="defaultAssignUserId" class="btn btn-default"><i class="fas fa-user"></i>Me</button>

                            </div>
                        </div>
                    </div>
                    <div class="row" style="height:40px;">
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>Progress</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <select name="progressFrom" class="form-control" id="progressFromSelectId">
                                    <option>Any</option>
                                    <option>0</option>
                                    <option>25</option>
                                    <option>50</option>
                                    <option>75</option>
                                    <option>100</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-1" style="text-align:center">
                            <div class="form-group">
                                <i class="fa fa-arrow-right"></i>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <select name="progressTo" class="form-control" id="progressToSelectId">
                                    <option>Any</option>
                                    <option>0</option>
                                    <option>25</option>
                                    <option>50</option>
                                    <option>75</option>
                                    <option>100</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2" style="text-align:right">
                            <div class="form-group">
                                <button id="clearProgressId" class="btn btn-default"><i class="fa fa-close"></i>Clear</button>
                            </div>
                        </div>
                    </div>
                    <div class="row" style="height:40px;">
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>Target Date</label>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <div class="input-group date" id="targetFromdate" data-target-input="nearest">
                                    <input id="fromRange" placeholder="From Date" type="text" class="form-control datetimepicker-input" data-target="#targetFromdate" />
                                    <div class="input-group-append" hidden data-target="#targetFromdate" data-toggle="datetimepicker">
                                        <div class="input-group-text"><i id="calendarFromtrigger" hidden class="fa fa-calendar"></i></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-1" style="text-align:center">
                            <div class="form-group">
                                <i class="fa fa-arrow-right"></i>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <div class="input-group date" id="targetTodate" data-target-input="nearest">
                                    <input id="toRange" placeholder="To Date" type="text" class="form-control datetimepicker-input" data-target="#targetTodate" />
                                    <div class="input-group-append" hidden data-target="#targetTodate" data-toggle="datetimepicker">
                                        <div class="input-group-text"><i id="calendarTotrigger" hidden class="fa fa-calendar"></i></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2" style="text-align:right">
                            <div class="form-group">
                                <button id="clearTargetId" class="btn btn-default"><i class="fa fa-close"></i>Clear</button>
                            </div>
                        </div>
                    </div>
                    <div class="row" style="height:40px;">
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>Created By</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                @*<input id="createdById" type="text" class="form-control">*@
                                <select id="createdByValuesId" class="select2" multiple="multiple" data-placeholder="Created by" style="width: 100%;">
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <button id="clearCreatedById" class="btn btn-default"><i class="fa fa-close"></i>Clear</button>
                                <button id="defaultCreatedByUserId" class="btn btn-default"><i class="fas fa-user"></i>Me</button>

                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <button type="button" id="filter-submit-id" class="btn btn-primary">Apply</button>
                    <button type="button" id="filter-reset-id" class="btn btn-default" data-dismiss="modal">Reset</button>
                </div>
            </div>
        </div>
        <!-- /.card -->
    </div>

    <div class="row">
        <div class="col-12">

            @{
                if (ViewData["deletionMessage"] != null)
                {
                    <div class="alert alert-danger alert-dismissible" role="alert">
                        <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                        @ViewData["deletionMessage"]
                    </div>
                }
            }

            <div class="card">
                <div class="card-header">
                    <button id="create-task-btnId" class="btn btn-info" data-toggle="ajax-modal" data-target="#add-contact" data-url="@Url.Action("Create")">Create Task</button>
                </div>
                <div id="modal-default">
                </div>
                <div id="modal-followup">
                </div>
                <div id="modal-multiple">
                </div>
                <!-- /.card-header -->
                <div class="card-body">
                    <table id="tasksTable" class="table table-bordered table-hover">
                        <thead>
                            <tr>
                                <th></th>
                                <th>TaskId</th>
                                <th>Title</th>
                                <th>Status</th>
                                <th class="progressCls">Progress</th>
                                <th>Assigned To</th>
                                <th>Last Updated</th>
                                <th>Update</th>
                                <th>Created By</th>
                                <th>Target Date</th>
                                <th>ProgressVal</th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <!-- /.card-body -->
            </div>
            <!-- /.card -->
            <!-- /.card -->
        </div>
        <!-- /.col -->
    </div>
    <!-- /.row -->
    <button id="take-followup-btnId" class="btn btn-info" data-toggle="ajax-modal" data-target="#add-contact1" data-url="@Url.Action("Create", "TaskFollowUps")">Follow up</button>
    <br />
    <br />

</div>


<!-- /.container-fluid -->

@section BodyScripts {
    <script src="https://timeago.yarp.com/jquery.timeago.js" type="text/javascript"></script>
    <script src="../../plugins/select2/js/select2.full.min.js"></script>


    <script>
        $(document).ready(function() {

            //Initialize Select2 Elements
            $('.select2').select2();
            var progressFrom = '0';
            var progressTo = '';
            var fromTargetDate = '';
            var toTargetDate = '';

            @if (ViewData["UserName"] != null)
            {
                <text>
                    $("#employeeDetailId").html("@ViewData["UserName"]");
                </text>
            }

            //Initialize Select2 Elements
            $('.select2bs4').select2({
            theme: 'bootstrap4'
            });

            var employeeDiv = $('#employeeDetailDiv');

            function showEmployeeDetails(userName) {
                
               var thisBaseUrl = "@Html.Raw(this.Context.Request.Scheme + "://" + this.Context.Request.Host)";

               $.ajax({
                   type: "GET",
                   url: thisBaseUrl + "/employeeDetail/Index",
                   contentType: "application/json; charset=utf-8",
                   data: {userName : userName},
                   datatype: "json",
                   success: function (data) {
                       employeeDiv.html(data);
                       employeeDiv.find('.modal').modal('show');
                       employeeDiv.show();

                       var employeeTasksTable = $('#employeeTasksTable').
                           DataTable({
                               paging: false,
                               info: false,
                               searching: false,
                               //scrollY:        300,
                               //scrollX:        true,
                               //scrollCollapse: true,
                               initComplete: function (settings, json) {
                                   var response = settings.json;
                                   $("#taskCount").html(response.pendingCount);

                                   var taskDonutData = {
                                       labels: [
                                           'Completed',
                                           'Not Started Yet',
                                           'In Progress',
                                           'On Hold',
                                           'Cancelled'
                                       ],
                                       datasets: [
                                           {
                                               data: [response.completedCount, response.notStartedCount,
                                               response.progressCount, response.onHoldCount, response.cancelledCount],
                                               backgroundColor: ['#00a65a', '#6c757d', '#f39c12', '#6f42c1', '#343a40'],
                                           }
                                       ]
                                   }

                                   var pieChartCanvas = $('#pieChart').get(0).getContext('2d');
                                   var pieData = taskDonutData;
                                   var pieOptions = {
                                       maintainAspectRatio: false,
                                       responsive: true,
                                   }
                                   //Create pie or douhnut chart
                                   // You can switch between pie and douhnut using the method below.
                                   var tasksPieChart = new Chart(pieChartCanvas, {
                                       type: 'pie',
                                       data: pieData,
                                       options: pieOptions
                                   });

                               },
                               search: { regex: true, caseInsensitive: true },
                               ajax: {
                                   "url": thisBaseUrl + "/employeeDetail/LoadEmployeeTasksData",
                                   "type": "POST",
                                   "datatype": "json",
                                   "data": { userName : userName }
                               },
                               columns: [
                                   {
                                       "render": function (data, type, full, meta) {
                                           return '<a href="' + thisBaseUrl + '/tasks/Edit?id=' + full.taskId + '"><u>' + full.title + '</u> </a>';
                                       }
                                   },
                                   {
                                       "render": function (data, type, full, meta) {
                                           if (full.status == "Not Started") {
                                               return '<span class="badge badge-secondary">Not Started</span>';
                                           }
                                           else
                                            if (full.status == "In Progress") {
                                                return '<span class="badge badge-warning text-white"> In Progress</span > ';
                                            }
                                            else
                                            if (full.status == "On Hold") {
                                                return '<span class="badge badge-secondary">On Hold</span>';
                                            }
                                            else
                                            if (full.status == "Cancelled") {
                                                return '<span class="badge badge-secondary">Cancelled</span>';
                                            }
                                            else
                                                return '<span class="badge badge-success">Completed</span>';
                                       }
                                   },
                                   { "data": "sortId", "name": "SortId", "autoWidth": true, "visible": false, "searchable": false },

                               ],
                               order: [[2, 'asc']]
                           });

                       var employeefollowUpsTable = $('#employeefollowUpsTable').
                           DataTable({
                               paging: false,
                               info: false,
                               searching: false,
                               //pageLength: 10,
                               //"scrollY": 200,
                               initComplete: function (settings, json) {
                                   $("#followupCount").html(this.api().data().length);
                                   var response = settings.json;
                                   var followupsDonutData = {
                                       labels: [
                                           'Pending',
                                           'Completed'
                                       ],
                                       datasets: [
                                           {
                                               data: [response.pendingFollowUps, response.completedFollowUps],
                                               backgroundColor: ['#f39c12', '#00a65a'],
                                           }
                                       ]
                                   }

                                   var pieChartCanvas2 = $('#pieChart2').get(0).getContext('2d');
                                   var pieData = followupsDonutData;
                                   var pieOptions = {
                                       maintainAspectRatio: false,
                                       responsive: true,
                                   }
                                   //Create pie or douhnut chart
                                   // You can switch between pie and douhnut using the method below.
                                   var followupPieChart = new Chart(pieChartCanvas2, {
                                       type: 'pie',
                                       data: pieData,
                                       options: pieOptions
                                   });
                               },
                               search: { regex: true, caseInsensitive: true },
                               ajax: {
                                   "url": thisBaseUrl + "/employeeDetail/LoadEmployeeFollowUps",
                                   "type": "POST",
                                   "datatype": "json",
                                   "data": { userName : userName }
                               },
                               columns: [
                                   {
                                       "render": function (data, type, full, meta) {
                                           return '<a href="' + thisBaseUrl + '/tasks/Edit?id=' + full.taskId + '"><u>' + full.taskInfo + '</u> </a>';
                                       }
                                   },
                                   { "data": "followUpFrom", "name": "Follow Up From", "autoWidth": true, "visible": true, "searchable": true },
                                   {
                                       "render": function (data, type, full, meta) {
                                           if (full.status == "Not Started") {
                                               return '<span class="badge badge-secondary">Not Started</span>';
                                           }
                                           else
                                            if (full.status == "In Progress") {
                                                return '<span class="badge badge-warning text-white"> In Progress</span > ';
                                            }
                                            else
                                            if (full.status == "On Hold") {
                                                return '<span class="badge badge-secondary">On Hold</span>';
                                            }
                                            else
                                            if (full.status == "Cancelled") {
                                                return '<span class="badge badge-secondary">Cancelled</span>';
                                            }
                                            else
                                                return '<span class="badge badge-success">Completed</span>';
                                       }
                                   },
                                   { "data": "sortId", "name": "SortId", "autoWidth": true, "visible": false, "searchable": false }
                               ],
                               order: [[3, 'asc']]
                           });

                       $("#employee-closePopup-icon").click(function () {
                           $('.modal-backdrop').removeClass("modal-backdrop");
                           employeeDiv.hide();
                       });
                   },
                   error: function () {
                       alert("Dynamic content load failed.");
                   }
               });
           }

            var allEmployeeList = [];

            $('#targetFromdate').datetimepicker({
                format: 'DD-MMM-yyyy'

            });

            $('#targetTodate').datetimepicker({
                format: 'DD-MMM-yyyy'
            });

            $("#fromRange").click(function () {
                $("#calendarFromtrigger").click();
            });

             $("#toRange").click(function () {
                $("#calendarTotrigger").click();
             });

            $("#clearTaskNameId").click(function () {
                $("#taskNameId").val("");
            });

            $("#clearStatusId").click(function () {
                $("#statusSelectValuesId").val('').trigger('change');
            });

            $("#defaultStatusId").click(function () {
                $("#statusSelectValuesId").val('').trigger('change');
                $("#statusSelectValuesId").val($("#statusSelectValuesId option:first").val()).trigger('change');
            });

            $("#defaultAssignUserId").click(function () {
                $("#assignSelectValuesId").val('').trigger('change');
                currentUserName = "@Model.CurrentUserName";
                //currentUserName = 'Kashif';
                $("#assignSelectValuesId").val(currentUserName).trigger('change');
            });

            $("#defaultCreatedByUserId").click(function () {
                $("#createdByValuesId").val('').trigger('change');
                currentUserName = "@Model.CurrentUserName";
                $("#createdByValuesId").val(currentUserName).trigger('change');
            });

            $("#clearAssignId").click(function () {
                $("#assignSelectValuesId").val('').trigger('change');
            });

            $("#clearProgressId").click(function () {
                $("#progressFromSelectId").val($("#progressFromSelectId option:first").val());
                $("#progressToSelectId").val($("#progressToSelectId option:first").val());
            });

             $("#clearTargetId").click(function () {
                 $("#fromRange").val('');
                 $("#toRange").val('');
             });

              $("#clearCreatedById").click(function () {
                  $("#createdByValuesId").val('').trigger('change');
            });

            $('#statusSelectValuesId').select2({
                allowClear: true,
                minimumResultsForSearch: -1,
                width: 500
            });

            $("#assignSelectValuesId").select2({
                allowClear: true,
                minimumResultsForSearch: -1,
                width: 500
            });

            $("#createdByValuesId").select2({
                allowClear: true,
                minimumResultsForSearch: -1,
                width: 500
            });

            $("#filter-submit-id").click(function () {

                var taskName = ($("#taskNameId").val() != "") ? $("#taskNameId").val() : "";
                var createdBy = "";
                $('#createdByValuesId > option:selected').each(function() {
                    createdBy += $(this).val() + "|";
                });
                if (createdBy.length > 0) {
                    createdBy = createdBy.substring(0, createdBy.length - 1);
                }

                var selectStatuses = '';
                $('#statusSelectValuesId > option:selected').each(function() {
                    selectStatuses += $(this).val() + "|";
                });
                if (selectStatuses.length > 0) {
                    selectStatuses = selectStatuses.substring(0, selectStatuses.length - 1);
                }

                var assignedToValues = '';
                $('#assignSelectValuesId > option:selected').each(function() {
                    assignedToValues += $(this).val() + "|";
                });
                if (assignedToValues.length > 0) {
                    assignedToValues = assignedToValues.substring(0, assignedToValues.length - 1);
                }

                $('#progressFromSelectId > option:selected').each(function() {
                    progressFrom = $(this).val();
                });

                 $('#progressToSelectId > option:selected').each(function() {
                    progressTo = $(this).val();
                 });

                var isValid = true;
                if (progressTo != '') {
                    if (parseInt(progressTo) < parseInt(progressFrom)) {
                        alert('Progress range is not valid. Progress to value can not be less than progress from value');
                        isValid = false;
                    }
                }

                if ($("#fromRange").val() != '') {
                    var d = new Date($("#fromRange").val());
                    fromTargetDate = d;
                }
                if ($("#toRange").val() != '') {
                    var d = new Date($("#toRange").val());
                    toTargetDate = d;

                    if (fromTargetDate != '') {
                        if (toTargetDate.getTime() < fromTargetDate.getTime()) {
                            alert('Target to Date can not be less than Target from range');
                            isValid = false;
                        }
                    }
                }

                if (isValid) {
                    tasksTable.column(2).search(taskName, true, false)
                        .column(3).search(selectStatuses, true, false)
                        .column(5).search(assignedToValues, true, false)
                        .column(8).search(createdBy, true, false)
                        .draw();
                }
            });


            $("#filter-reset-id").click(function () {

                $("#taskNameId").val("");

                $("#statusSelectValuesId").val('').trigger('change');
                $("#assignSelectValuesId").val('').trigger('change');
                $("#createdByValuesId").val('').trigger('change');
                $("#progressFromSelectId").val($("#progressFromSelectId option:first").val());
                $("#progressToSelectId").val($("#progressToSelectId option:first").val());
                $("#fromRange").val('');
                progressFrom = '0';
                progressTo = '';
                $("#toRange").val('');
                $("#createdById").val('');
                fromTargetDate = '';
                toTargetDate = '';

                 tasksTable.column(2).search('', true, false)
                .column(3).search('', true, false)
                .column(5).search('', true, false)
                .column(8).search('', true, false)
                .draw();
            });


            var summaryplaceHolder = $("#summaryRow");

            var thisPage = '../tasks';
            $(".nav-sidebar .nav-item .nav-link").each(function () {
                $(this).removeClass("active");
                var href = $(this).attr('href');
                if (href == thisPage) {
                    $(this).addClass('active');
                }
            });


            function validateTargetDateFilter(thisTargetDate) {

                if (thisTargetDate != '') {
                    thisTargetDate = new Date(thisTargetDate);
                }
                var min = '';
                if (fromTargetDate != '') {
                    min = new Date(fromTargetDate);;
                }

                if (min != '') {
                    if (toTargetDate != '') {
                        var max = new Date(toTargetDate);
                        max.setHours(max.getHours() + 23);
                        if (thisTargetDate.getTime() >= min.getTime() && thisTargetDate <= max.getTime()) {
                            return true;
                        }
                        else
                            return false;
                    }
                    else {
                        if (thisTargetDate.getTime() >= min.getTime()) {
                            return true;
                        }
                        else
                            return false;
                    }
                }
                else {
                    min = new Date('0001-01-01T00:00:00');
                    if (toTargetDate != '') {
                        var max = new Date(toTargetDate);
                        max.setHours(max.getHours() + 23);
                        if (thisTargetDate.getTime() >= min.getTime() && thisTargetDate.getTime() <= max.getTime()) {
                            return true;
                        }
                        else
                            return false;
                    }
                    else if (thisTargetDate.getTime() >= min.getTime()) {
                        return true;
                    }
                    else
                        return false;
                }
            }


            function validateProgressFilter(thisProgress) {
                 if (isNaN(progressFrom)) {
                        progressFrom = '0';
                    }
                    thisProgress = parseInt(thisProgress);
                    var min = parseInt(progressFrom);
                    if (min != 0) {
                        if (progressTo != 'Any' && progressTo != '') {
                            var max = parseInt(progressTo);
                            if (thisProgress >= min && thisProgress <= max) {
                                return true;
                            }
                            else
                                return false;
                        }
                        else {
                            if (thisProgress >= min) {
                                return true;
                            }
                            else
                                return false;
                        }
                    }
                    else {
                        if (progressTo != 'Any' && progressTo != '') {
                            var max = parseInt(progressTo);
                            if (thisProgress >= min && thisProgress <= max) {
                                return true;
                            }
                            else
                                return false;
                        }
                        else if (thisProgress >= min) {
                            return true;
                        }
                        else
                            return false;
                    }
            }


            /* Custom filtering function which will search data in column four between two values */
            $.fn.dataTable.ext.search.push(
                function (settings, data, dataIndex) {
                    var isValid = validateProgressFilter(data[10]);
                    if (isValid) {
                        isValid = validateTargetDateFilter(data[9]);
                    }
                    return isValid;
                }
            );

            var baseUrl = "@Html.Raw(this.Context.Request.Scheme + "://" + this.Context.Request.Host + this.Context.Request.Path)";
            var tasksTable = $('#tasksTable')
                .on('init.dt', function () {

                    
                }).on('page.dt', function () {
                    setTimeout(
                    function()
                    {
                            $(".knob").knob({});
                    }, 100);
                }).
                DataTable({
                    paging: true,
                    initComplete: function (settings, json) {
                        $("a[name='employeeDetailLink']").click(function () {
                            showEmployeeDetails($(this).html());
                        });
                        console.log("init complete");
                        $(".knob").knob({});
                    },
                columnDefs: [ {
                    orderable: false,
                    className: 'select-checkbox',
                    targets:   0
                }
                    ],
                select: {
                    style:    'multiple',
                    selector: 'td:first-child'
                    },
                search: {regex: true, caseInsensitive: true},
                 ajax: {
                    "url": baseUrl + "/LoadTasksData",
                    "type": "POST",
                    "datatype": "json"
                 },
                 columns: [
                     {
                        data: null, render: function (data, type, row)
                        {
                            return "";
                        }
                    },
                    { "data" : "taskId", "name": "TaskId", "autoWidth": true, "visible" : false, "searchable" : true},
                    { "data": "title", "name": "Title", "autoWidth": true },
                    {
                         "render": function (data, type, full, meta)
                        {
                             if (full.status == "Not Started") {
                                 return '<span class="badge badge-secondary">Not Started</span>';
                             }
                             else
                             if (full.status == "In Progress") {
                                 return '<span class="badge badge-warning text-white"> In Progress</span > ';
                             }
                             else
                             if (full.status == "On Hold") {
                                return '<span class="badge badge-secondary">On Hold</span>';
                             }
                             else
                             if (full.status == "Cancelled") {
                                return '<span class="badge badge-secondary">Cancelled</span>';
                             }
                             else
                                 return '<span class="badge badge-success">Completed</span>';
                         }
                    },
                     {

                         "render": function (data, type, full, meta) {

                             var color = "";
                             if (full.status == "Not Started") {
                                 color = 'ffc107';
                             }
                             else
                             if (full.status == "In Progress") {
                                 color = 'ffc107';
                             }
                             else
                             if (full.status == "On Hold") {
                                color = '6c757d';
                             }
                             else
                             if (full.status == "Cancelled") {
                                color = '6c757d';
                             }
                             else
                                 color = '28a745';

                              return '<input type =\"text\" class=\"knob gridknob\" value=\"'+ full.progress+ '%'+'\" data-width=\"50\" data-height=\"50\"' +
                                "data-fgColor=\"#"+color+"\">";
                         }
                    },
                    {
                        "render": function (data, type, full, meta) {
                            return '<a href="javascript:void(null);"  name="employeeDetailLink">' + full.assignedTo +'</span>';
                         }
                    },
                    {
                        "render": function (data, type, full, meta) {
                            return '<span title="'+full.lastUpdated+'" name="lastupdatedLink">' + jQuery.timeago(full.lastUpdated) +'</span>';
                         }
                    },
                    {
                        "render": function (data, type, full, meta)
                        { return '<a class="btn btn-info" href="' + baseUrl + '/Edit?id=' + full.taskId + '">Edit</a>'; }
                     },
                    { "data": "createdBy", "name": "Created By", "autoWidth": true, "visible": false, "searchable": true },
                    { "data": "targetDate", "name": "Target Date", "autoWidth": true, "visible": false, "searchable": true },
                    { "data" : "progress", "name": "ProgressVal", "autoWidth": true, "visible" : false, "searchable" : true},
                ],
                order: [[ 1, 'desc' ]]
            });

            var taskCreationPlaceHolder = $('#modal-default');
            var taskMultipleCreationPlaceHolder = $('#modal-multiple');
            var taskFollowUpPlaceHolder = $('#modal-followup');

             $("#create-task-btnId").click(function () {
                var $buttonClicked = $(this);
                var options = { "backdrop": "static", keyboard: true };
                $.ajax({
                    type: "GET",
                    url:  baseUrl + "/Create",
                    contentType: "application/json; charset=utf-8",
                    data:null,
                    datatype: "json",
                    success: function (data) {
                        taskCreationPlaceHolder.html(data);
                        taskCreationPlaceHolder.find('.modal').modal(options);
                        taskCreationPlaceHolder.find('.modal').modal('show');

                        $("#addMultipleCreationLink").click(function () {
                            $.ajax({
                                type: "GET",
                                url:  baseUrl + "/CreateMultiple",
                                contentType: "application/json; charset=utf-8",
                                data:null,
                                datatype: "json",
                                success: function (data) {
                                    taskMultipleCreationPlaceHolder.html(data);
                                    taskMultipleCreationPlaceHolder.find('.modal').modal(options);
                                    taskMultipleCreationPlaceHolder.find('.modal').modal('show');
                                },
                                error: function () {
                                    alert("Dynamic content load failed.");
                                }
                            });
                        });
                    },
                    error: function () {
                        alert("Dynamic content load failed.");
                    }
                });
             });



            $("#take-followup-btnId").click(function () {
                var $buttonClicked = $(this);

                var row_data = tasksTable.rows('.selected').data();
                if (row_data.length > 0) {
                    var options = { "backdrop": "static", keyboard: true };
                    $.ajax({
                        type: "GET",
                        url: baseUrl.replace("/tasks", "/taskfollowups") + "/Create",
                        contentType: "application/json; charset=utf-8",
                        data: null,
                        datatype: "json",
                        success: function (data) {
                            taskFollowUpPlaceHolder.html(data);
                            taskFollowUpPlaceHolder.find('.modal').modal(options);
                            taskFollowUpPlaceHolder.find('.modal').modal('show');
                        },
                        error: function () {
                            alert("Dynamic content load failed.");
                        }
                    });
                }
                else {
                    alert("Please select task for followup");
                }
            });


            function getSummaryInfo() {

                $.ajax({
                    type: "GET",
                    url: baseUrl.replace("tasks", "") + "TaskSummary/list",
                    contentType: "application/json; charset=utf-8",
                    data: null,
                    datatype: "json",
                    success: function (data) {
                        $.each(data, function (i, val) {
                            tmpData = data[i];   

                            $(".knob").knob({});
                            $('#pendingTasksId').trigger(
                                'configure',
                                {
                                    "min":0,
                                    "max": tmpData.totalTasksCount,
                                    "fgColor":"#ffc107",
                                    "cursor": false
                                }
                            );
                            $("#pendingTasksId").val(tmpData.pendingTasksCount).trigger('change');
                            $('#completedTasksId').trigger(
                                'configure',
                                {
                                    "min":0,
                                    "max": tmpData.totalTasksCount,
                                    "fgColor":"#28a745",
                                    "cursor": false
                                }
                            );

                            $("#completedTasksId").val(tmpData.completedTasksCount).trigger('change');
                            $('#onHoldTaskId').trigger(
                                'configure',
                                {
                                    "min":0,
                                    "max": tmpData.totalTasksCount,
                                    "fgColor":"#6c757d",
                                    "cursor": false
                                }
                            );

                            $("#onHoldTaskId").val(tmpData.onHoldTasksCount).trigger('change');

                            $('#totalTasksId').trigger(
                                'configure',
                                {
                                    "min":0,
                                    "max": tmpData.totalTasksCount,
                                    "fgColor":"#3c8dbc",
                                    "cursor": false
                                }
                            );
                            $("#totalTasksId").val(tmpData.totalTasksCount).trigger('change');;
                            //$("input.knob").trigger('change');
                            console.log("change complete");
                        });
                    },
                    error: function () {
                        alert("Dynamic content load failed.");
                    }
                });
            }


            function getAllEmployees() {
                    
                    $.ajax({
                    type: "GET",
                    url: baseUrl.replace("tasks", "") + "TaskEmployees/AllEmployees",
                    contentType: "application/json; charset=utf-8",
                    data: null,
                    datatype: "json",
                    success: function (data) {
                        $.each(data, function (i, val) {
                            tmpData = data[i];
                            $.each(tmpData, function (i, val) {
                                allEmployeeList.push(tmpData[i].userName);
                                 var o = new Option(tmpData[i].userName, tmpData[i].userName);
                                /// jquerify the DOM object 'o' so we can use the html method
                                $(o).html(tmpData[i].userName);
                                $("#assignSelectValuesId").append(o);
                                var o1 = new Option(tmpData[i].userName, tmpData[i].userName);
                                $(o1).html(tmpData[i].userName);
                                $("#createdByValuesId").append(o1);
                            });
                        });
                    },
                    error: function () {
                        alert("Dynamic content load failed.");
                    }
                });
            }

            taskFollowUpPlaceHolder.on('click', '[data-save="modal"]', function (event) {
                event.preventDefault();

                var row_data = tasksTable.rows('.selected').data();
                var listOfTaskIds = "";
                $.each(row_data, function (i, val) {
                    tmpData = row_data[i];
                    listOfTaskIds += tmpData["taskId"] + ","
                });
                listOfTaskIds = listOfTaskIds.substring(0, listOfTaskIds.length - 1);
                $("#ListofTasks").val(listOfTaskIds);

                var form = $(this).parents('.modal').find('form');
                var actionUrl = form.attr('action');
                var dataToSend = form.serialize();
                $("#spinnerFollowUpCreate").show();

                $.post(actionUrl, dataToSend).done(function (data) {
                    var newBody = $('.modal-body', data);
                    $("#spinnerFollowUpCreate").hide();
                    taskFollowUpPlaceHolder.find('.modal-body').replaceWith(newBody);
                    var isValid = newBody.find('[name="IsValid"]').val() == 'True';
                    if (isValid) {
                        taskFollowUpPlaceHolder.find('.modal').modal('hide');
                        tasksTable.ajax.reload(function () {
                             setTimeout(
                                function()
                                {
                                        $(".knob").knob({});
                                }, 100);
                        });
                    }
                });
            });


            taskMultipleCreationPlaceHolder.on('click', '[data-save="modal"]', function (event) {
                event.preventDefault();
                var enteredText = $(this).parents('.modal').find('#ListOfTaskTitles').val();
                var rows = enteredText.split(/\r?\n/);
                var listOfTaskNames = "";
                for (var i = 0; i < rows.length; i++) {
                    if (rows[i].trim() != "") {
                        listOfTaskNames += rows[i] + ","
                    }
                }
                listOfTaskNames = listOfTaskNames.substring(0, listOfTaskNames.length - 1);
                $("#ListOfTaskTitles").val(listOfTaskNames);
                $(this).parents('.modal').find('#Target').val($("#Target").val());
                $(this).parents('.modal').find('#TaskProgress').val($("#TaskProgress").val());
                $(this).parents('.modal').find('#Description').val($("#Description").val());
                $(this).parents('.modal').find('#PriorityId').val($("#PriorityId").val());
                $(this).parents('.modal').find('#AssigneeCode').val($("#AssigneeCode").val());

                var form = $(this).parents('.modal').find('form');
                var actionUrl = form.attr('action');
                var dataToSend = form.serialize();
                var buttonClickedId = $(this).attr('id');
                $.post(actionUrl, dataToSend).done(function (data) {
                    var newbody = $('.modal-body', data);
                    taskMultipleCreationPlaceHolder.find('.modal-body').replaceWith(newbody);
                    var isValid = newbody.find('[name="IsValid"]').val() == 'True';
                    if (isValid) {

                        taskMultipleCreationPlaceHolder.find('.modal').modal('hide');
                        taskCreationPlaceHolder.find('.modal').modal('hide');
                        tasksTable.ajax.reload(function () {
                             setTimeout(
                                function()
                                {
                                        $(".knob").knob({});
                                }, 100);
                        });
                    }
                });
            });

            taskCreationPlaceHolder.on('click', '[data-save="modal"]', function (event) {
                event.preventDefault();

                var form = $(this).parents('.modal').find('form');
                var actionUrl = form.attr('action');
                var dataToSend = form.serialize();
                var buttonClickedId = $(this).attr('id');
                $("#spinnerCreate").show();

                $.post(actionUrl, dataToSend).done(function (data) {
                    var newbody = $('.modal-body', data);
                    taskCreationPlaceHolder.find('.modal-body').replaceWith(newbody);
                    var isValid = newbody.find('[name="IsValid"]').val() == 'True';
                    $("#spinnerCreate").hide();
                    if (isValid) {
                        if (buttonClickedId == "task-submit-btnId") {
                            taskCreationPlaceHolder.find('.modal').modal('hide');
                        }
                        else {
                            getSummaryInfo();
                            alert("Task added");
                        }
                        tasksTable.ajax.reload(function () {
                             setTimeout(
                                function()
                                {
                                        $(".knob").knob({});
                                }, 100);
                        });
                    }
                });
            });

            getAllEmployees();
            getSummaryInfo();

        });
    </script>
}
